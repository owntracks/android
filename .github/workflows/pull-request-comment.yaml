---
# When a comment is made on a pull request starting with '/run-tests' by a org member, this workflow
# grabs the current PR, creates a checkpoint status for PR head sha and runs a build / test. If
# successful, it updates the checkpoint status to success, which then allows the PR to be merged.
name: PR comment trigger

"on":
  issue_comment:
    types: [created]

jobs:
  check-comment:
    name: PR Comment
    runs-on: ubuntu-latest
    permissions:
      contents: read
      checks: write
    outputs:
      sha: ${{ fromJson(steps.get-pr-info.outputs.result).sha }}
    if: |
      github.event.issue.pull_request &&
      startsWith(github.event.comment.body,'/run-tests') &&
      github.event.comment.author_association == 'MEMBER'
    steps:
      - name: Get PR info
        uses: actions/github-script@v7
        id: get-pr-info
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            if (!pr) {
              throw new Error('Pull request not found');
            }
            runId = process.env.GITHUB_RUN_ID;
            console.log(`Pull request head SHA: ${pr.head.sha}`);
            await github.rest.checks.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              name: 'PR Checkpoint Status',
              head_sha: pr.head.sha,
              status: 'in_progress',
              started_at: new Date().toISOString(),
              details_url: `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${runId}`,
              output: {
                title: 'Build & Test in Progress',
                summary: 'Build and test are in progress.',
                text: 'Build and test are in progress.'
              }
            });
            return {
              sha: pr.head.sha
            };
  build-test-lint:
    name: Build, Test, and Lint
    needs: [check-comment]
    permissions:
      contents: read
      checks: write
    uses: ./.github/workflows/build-test-lint.yaml
    with:
      ref: ${{ needs.check-comment.outputs.sha }}
    secrets: inherit
  pr-checkpoint-status:
    name: "PR Checkpoint Status"
    runs-on: ubuntu-latest
    permissions:
      actions: read
      statuses: write
      checks: write
    needs: [check-comment, build-test-lint]
    steps:
      - name: Set status check
        uses: actions/github-script@v7
        env:
          SHA: ${{ needs.check-comment.outputs.sha }}
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const { owner, repo } = context.repo;
            const sha = process.env.SHA;
            console.log(`Setting status check for SHA: ${sha}`);
            await github.rest.checks.create({
              owner,
              repo,
              name: 'PR Checkpoint Status',
              head_sha: sha,
              status: 'completed',
              conclusion: 'success',
              output: {
                title: 'Build & Test Completed',
                summary: 'All checks passed successfully.',
                text: 'All checks passed successfully.'
              }
            });
            const { data: checkRuns } = await github.rest.checks.listForRef({
              owner,
              repo,
              ref: sha
            });
            console.log(`Check runs: ${JSON.stringify(checkRuns)}`);
